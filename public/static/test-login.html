<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Login - Cantina Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    ğŸ½ï¸ Teste de Login
                </h1>
                <p class="text-gray-600">DiagnÃ³stico do Sistema</p>
            </div>

            <div id="status" class="mb-4 p-4 rounded-lg bg-blue-50 text-blue-800 text-sm">
                Aguardando login...
            </div>

            <form id="test-login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Email
                    </label>
                    <input 
                        type="email" 
                        id="test-email"
                        value="admin@cantina.com"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Senha
                    </label>
                    <input 
                        type="password" 
                        id="test-password"
                        value="admin123"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                </div>

                <button 
                    type="submit"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all duration-200"
                >
                    Testar Login
                </button>
            </form>

            <div id="logs" class="mt-6 p-4 bg-gray-50 rounded-lg max-h-96 overflow-y-auto">
                <h3 class="font-semibold text-gray-700 mb-2">Logs:</h3>
                <div id="log-content" class="text-xs text-gray-600 space-y-1 font-mono"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || colors.info;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const colors = {
                info: 'bg-blue-50 text-blue-800',
                success: 'bg-green-50 text-green-800',
                error: 'bg-red-50 text-red-800',
                warning: 'bg-yellow-50 text-yellow-800'
            };
            
            statusDiv.className = `mb-4 p-4 rounded-lg ${colors[type]} text-sm`;
            statusDiv.textContent = message;
        }

        async function testLogin(email, password) {
            addLog('ğŸš€ Iniciando teste de login...', 'info');
            addLog(`ğŸ“§ Email: ${email}`, 'info');
            addLog(`ğŸ”‘ Senha: ${'*'.repeat(password.length)}`, 'info');
            
            try {
                addLog('ğŸ“¡ Montando requisiÃ§Ã£o...', 'info');
                const url = `${API_BASE}/auth/login`;
                addLog(`ğŸŒ URL: ${url}`, 'info');
                
                const body = JSON.stringify({ email, password });
                addLog(`ğŸ“¦ Body: ${body}`, 'info');
                
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: body
                };
                addLog(`âš™ï¸ OpÃ§Ãµes: ${JSON.stringify(options, null, 2)}`, 'info');
                
                addLog('ğŸŒ Enviando requisiÃ§Ã£o...', 'warning');
                updateStatus('Enviando requisiÃ§Ã£o...', 'warning');
                
                const response = await fetch(url, options);
                
                addLog(`ğŸ“¥ Resposta recebida: Status ${response.status}`, response.ok ? 'success' : 'error');
                addLog(`ğŸ“Š Headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`âŒ Erro na resposta: ${errorText}`, 'error');
                    updateStatus(`Erro: ${response.status} - ${errorText}`, 'error');
                    return;
                }
                
                const data = await response.json();
                addLog(`âœ… Dados recebidos: ${JSON.stringify(data, null, 2)}`, 'success');
                
                if (data.token) {
                    addLog(`ğŸŸï¸ Token: ${data.token.substring(0, 20)}...`, 'success');
                    addLog(`ğŸ‘¤ UsuÃ¡rio: ${JSON.stringify(data.user)}`, 'success');
                    updateStatus(`âœ… Login bem-sucedido! UsuÃ¡rio: ${data.user.name} (${data.user.role})`, 'success');
                    
                    // Testar se consegue acessar dados do usuÃ¡rio
                    addLog('ğŸ” Testando acesso com token...', 'info');
                    const meResponse = await fetch(`${API_BASE}/users/me`, {
                        headers: {
                            'Authorization': `Bearer ${data.token}`
                        }
                    });
                    
                    if (meResponse.ok) {
                        const meData = await meResponse.json();
                        addLog(`âœ… Token vÃ¡lido! Dados: ${JSON.stringify(meData)}`, 'success');
                    } else {
                        addLog(`âš ï¸ Token invÃ¡lido ou expirado`, 'warning');
                    }
                } else {
                    addLog('âš ï¸ Resposta sem token!', 'warning');
                    updateStatus('Resposta sem token!', 'warning');
                }
                
            } catch (error) {
                addLog(`âŒ Erro fatal: ${error.message}`, 'error');
                addLog(`ğŸ“‹ Stack: ${error.stack}`, 'error');
                updateStatus(`âŒ Erro: ${error.message}`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            addLog('âœ… DOM carregado', 'success');
            addLog(`ğŸŒ URL atual: ${window.location.href}`, 'info');
            addLog(`ğŸ”§ API Base: ${API_BASE}`, 'info');
            
            const form = document.getElementById('test-login-form');
            addLog('âœ… FormulÃ¡rio encontrado', 'success');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                addLog('ğŸ›‘ Evento submit interceptado', 'success');
                
                const email = document.getElementById('test-email').value;
                const password = document.getElementById('test-password').value;
                
                await testLogin(email, password);
            });
            
            addLog('âœ… Event listener registrado', 'success');
            addLog('ğŸ¯ Sistema pronto para teste!', 'success');
            updateStatus('âœ… Sistema pronto! Clique em "Testar Login"', 'success');
        });
    </script>
</body>
</html>
